<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LinuxCNC PoKeysLib-Comp: ðŸ“„ PoKeysLibHal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom_doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">LinuxCNC PoKeysLib-Comp
   </div>
   <div id="projectbrief">unofficial PoKeys HAL-Component for LinuxCNC</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__home_cnc_actions_runner__work_LinuxCnc_PokeysLibComp_LinuxCnc_PokeysLibComp_external_pokeysHal_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">ðŸ“„ PoKeysLibHal </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md591"></a>
Purpose</h1>
<p >This project provides an optimized PoKeysLib UDP/Ethernet communication layer for <b>hard realtime use</b> (LinuxCNC).</p>
<ul>
<li>Asynchronous non-blocking communication</li>
<li>Automatic mapping of device responses into HAL-safe memory</li>
<li>Clean timeout and retry handling</li>
<li>Realtime-compatible design with minimal CPU usage</li>
</ul>
<h1><a class="anchor" id="autotoc_md592"></a>
Architecture</h1>
<ul>
<li><b>Mailbox System</b>: Each outgoing request is stored with a <code>target_ptr</code>.</li>
<li><b>Send Thread</b>: Sends prepared packets without blocking.</li>
<li><b>Receive Thread</b>: Matches responses automatically to pending requests and fills <code>target_ptr</code> directly.</li>
<li><b>Timeout Checker</b>: Retries or flags errors on missing responses.</li>
<li><b>No Manual Parsing</b>: Response payloads are copied automatically into preassigned structures.</li>
</ul>
<h1><a class="anchor" id="autotoc_md593"></a>
Key Features</h1>
<ul>
<li>No blocking operations in realtime threads</li>
<li>Fully fits LinuxCNC HAL types (<code>hal_s32_t</code>, <code>hal_bit_t</code>, <code>hal_float_t</code>)</li>
<li>Easily extendable for additional device features</li>
<li>Fast, safe, and predictable response handling</li>
<li>Clear separation of send and receive flow</li>
</ul>
<h1><a class="anchor" id="autotoc_md594"></a>
Security Commands</h1>
<p >The library now supports PoKeys security management:</p>
<ul>
<li><b>PK_SecurityStatusGet</b> (command <code>0xE1</code>)<ul>
<li>Request: no parameters.</li>
<li>Response: byte 9 contains the current security level, bytes 10â€“41 contain a 32-byte seed used when hashing the password.</li>
</ul>
</li>
<li><b>PK_UserAuthorise</b> (command <code>0xE2</code>)<ul>
<li>Request: param1 is desired security level; payload is 20-byte SHAâ€‘1 password hash.</li>
<li>Response: byte 9 is the unlock status (<code>0xAA</code> if successful).</li>
</ul>
</li>
<li><b>PK_UserPasswordSet</b> (command <code>0xE3</code>)<ul>
<li>Request: param1 is default security level; payload is the password in plain text (32 bytes).</li>
<li>Response: header only (no additional data).</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md595"></a>
Flowchart</h1>
<div class="fragment"><div class="line">[RT-Thread]                   [Background Receive]</div>
<div class="line">    |                                  |</div>
<div class="line">    | --&gt; Create &amp; Send Request        |</div>
<div class="line">    | --&gt; Insert Mailbox Entry         |</div>
<div class="line">    |                                  |&lt;-- UDP Packet arrives</div>
<div class="line">    |                                  |--&gt; Find matching Mailbox Entry</div>
<div class="line">    |                                  |--&gt; Write Response to target_ptr</div>
<div class="line">    |                                  |--&gt; Mark response_ready = true</div>
<div class="line">    |</div>
<div class="line">    | --&gt; Poll Mailbox Entries</div>
<div class="line">    | --&gt; If response_ready, process data</div>
<div class="line">    | --&gt; If timeout, retry or set error</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md596"></a>
Notes</h1>
<ul>
<li>UDP Socket must operate <b>non-blocking</b>.</li>
<li>Memory for mailbox and HAL data should be locked (<code>mlockall()</code> recommended).</li>
<li>No dynamic memory allocation inside realtime threads.</li>
</ul>
<hr  />
 <h1><a class="anchor" id="autotoc_md598"></a>
Async Core Routines</h1>
<ul>
<li><b>PK_EnumerateUSBDevicesAsync</b><ul>
<li>Non-blocking enumeration of USB devices.</li>
<li>Call repeatedly with a persistent <code><a class="el" href="structPKUSBEnumerator.html">PKUSBEnumerator</a></code> until the return value is non-negative. <code>-2</code> indicates enumeration is still in progress; <code>-1</code> reports an error.</li>
<li>When finished the function returns the number of detected devices.</li>
</ul>
</li>
<li><b>PK_EnumerateUSBDevices</b><ul>
<li>Blocking enumeration variant that scans all USB interfaces in one call.</li>
<li>Returns the number of PoKeys devices found.</li>
</ul>
</li>
<li><b>PK_GetCurrentDeviceConnectionType</b><ul>
<li><code>device</code> pointer describing the PoKeys instance.</li>
<li>Returns the currently active connection type constant (USB, FastUSB or Network).</li>
</ul>
</li>
<li><b>CreateRequest</b><ul>
<li>Formats a 64â€‘byte request buffer with the command ID and four optional parameters. No I/O is performed.</li>
<li>Parameters <code>type</code>, <code>param1..param4</code> occupy bytes 1â€‘5 of the buffer.</li>
</ul>
</li>
<li><b>PK_CustomRequest</b><ul>
<li>Convenience helper which fills <code>device-&gt;request</code> using <code>CreateRequest</code> and immediately invokes <code>SendRequest</code>.</li>
<li>Parameters mirror those of <code>CreateRequest</code>.</li>
</ul>
</li>
<li><b>SendRequest_multiPart</b><ul>
<li>Transmits a prepared <code>PK_CMD_MULTIPART_PACKET</code> using either UDP or FastUSB depending on the device connection type.</li>
<li>Expects the multipart payload to be prepared in <code>device</code> beforehand.</li>
</ul>
</li>
<li><b>SendRequest</b><ul>
<li>Finalises the current request buffer (header, request ID, checksum), sends it and waits for the matching reply. The call blocks until a response is received or a timeout occurs.</li>
</ul>
</li>
<li><b>SendRequest_NoResponse</b><ul>
<li>Sends the formatted packet and returns immediately without waiting for any reply. Useful for commands that acknowledge by other means.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md599"></a>
Device Information Routines</h1>
<ul>
<li><b>CompareName</b><ul>
<li>Utility to test whether a device name begins with a given prefix.</li>
</ul>
</li>
<li><b>PK_DeviceDataGet</b><ul>
<li>Reads firmware and hardware identifiers, populating <code>device-&gt;DeviceData</code> and <code>device-&gt;info</code>.</li>
</ul>
</li>
<li><b>PK_FillPWMPinNumbers</b><ul>
<li>Populates <code>device-&gt;PWM.PWMpinIDs</code> with the PWM-capable pins for the current model.</li>
</ul>
</li>
<li><b>PK_DeviceNameSet</b><ul>
<li>Sends the name stored in <code>device-&gt;DeviceData.DeviceName</code> to the device.</li>
</ul>
</li>
<li><b>PK_NetworkConfigurationSet</b><ul>
<li>Writes IP address, subnet and gateway fields from <code>device-&gt;netDeviceData</code>.</li>
</ul>
</li>
<li><b>PK_DeviceActivation</b><ul>
<li>Uploads the activation code and stores the resulting option mask.</li>
</ul>
</li>
<li><b>PK_DeviceActivationClear</b><ul>
<li>Clears any stored activation information on the device.</li>
</ul>
</li>
<li><b>PK_SaveConfiguration</b><ul>
<li>Persists the current configuration in device flash.</li>
</ul>
</li>
<li><b>PK_ClearConfiguration</b><ul>
<li>Resets configuration to defaults without clearing the host structure.</li>
</ul>
</li>
<li><b>PK_CheckPinCapabilityByDevice</b><ul>
<li>Checks whether a pin supports a capability for a given device type mask.</li>
</ul>
</li>
<li><b>PK_CheckPinCapabilityByTypeID</b><ul>
<li>Same as above but uses an exact device type ID.</li>
</ul>
</li>
<li><b>PK_CheckPinCapability</b><ul>
<li>Convenience wrapper for the connected device instance.</li>
</ul>
</li>
<li><b>PK_CheckPinEnabledCapability</b><ul>
<li>Placeholder to query if a capability is actually enabled (currently returns <code>0</code>).</li>
</ul>
</li>
<li><b>PK_GetDebugValues</b><ul>
<li>Retrieves a table of diagnostic counters into the provided buffer.</li>
</ul>
</li>
<li><b>PK_SetFastUSBEnableStatus</b><ul>
<li>Enables or disables the FastUSB interface.</li>
</ul>
</li>
<li><b>PK_GetFastUSBEnableStatus</b><ul>
<li>Reads back the FastUSB enable flag.</li>
</ul>
</li>
<li><b>PK_ReadDeviceLog</b><ul>
<li>Fetches the device's internal log entries.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md600"></a>
Real-Time Clock Functions</h1>
<ul>
<li><b>PK_RTCGet</b><ul>
<li>Reads the current time from the device and stores it in the <code>device-&gt;RTC</code> structure fields.</li>
</ul>
</li>
<li><b>PK_RTCSet</b><ul>
<li>Sends the values from <code>device-&gt;RTC</code> to update the device's internal clock.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md601"></a>
Matrix Keyboard Functions</h1>
<ul>
<li><b>PK_MatrixKBConfigurationGet</b><ul>
<li>Reads matrix keyboard configuration and key mapping into <code>device-&gt;matrixKB</code>.</li>
</ul>
</li>
<li><b>PK_MatrixKBConfigurationSet</b><ul>
<li>Writes configuration and key mapping from <code>device-&gt;matrixKB</code> back to the device.</li>
</ul>
</li>
<li><b>PK_MatrixKBStatusGet</b><ul>
<li>Updates <code>device-&gt;matrixKB.matrixKBvalues</code> with the currently pressed keys.</li>
</ul>
</li>
<li><b>Asynchronous variants</b><ul>
<li><code>PK_MatrixKBConfigurationGetAsync</code>, <code>PK_MatrixKBConfigurationSetAsync</code> and <code>PK_MatrixKBStatusGetAsync</code> provide the same features without blocking and therefore introduce virtually no CPU overhead for realtime threads.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md602"></a>
Matrix LED Functions</h1>
<ul>
<li><b>PK_MatrixLEDConfigurationSet</b><ul>
<li>Sends the enable flags and geometry from <code>device-&gt;MatrixLED</code> to the device.</li>
</ul>
</li>
<li><b>PK_MatrixLEDConfigurationGet</b><ul>
<li>Reads back the display configuration into <code>device-&gt;MatrixLED</code>.</li>
</ul>
</li>
<li><b>PK_MatrixLEDUpdate</b><ul>
<li>Transfers pixel data for displays where <code>RefreshFlag</code> is set.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="autotoc_md603"></a>
Asynchronous IO Wrappers</h1>
<ul>
<li><b>PK_PinConfigurationGetAsync</b><ul>
<li>Asynchronous counterpart to <code>PK_PinConfigurationGet</code>.</li>
<li>Queues the same requests using <code>CreateRequestAsync</code> and returns immediately.</li>
</ul>
</li>
<li><b>PK_PinConfigurationSetAsync</b><ul>
<li>Asynchronous version of <code>PK_PinConfigurationSet</code>.</li>
<li>Builds the configuration packets and schedules them without waiting.</li>
</ul>
</li>
<li><b>PK_DigitalIOSetAsync</b><ul>
<li>Non-blocking wrapper around <code>PK_DigitalIOSet</code>.</li>
<li>Prepares the digital output payload and enqueues it via <code>CreateRequestAsync</code>.</li>
</ul>
</li>
<li><b>PK_LCDConfigurationGetAsync / SetAsync / UpdateAsync</b><ul>
<li>New helpers for the character LCD.</li>
<li>Use the same async request queue to avoid blocking the realtime thread.</li>
</ul>
</li>
<li><b>PK_UARTConfigureAsync / WriteAsync / ReadAsync</b><ul>
<li>Non-blocking UART helpers using the same async queue. </li>
</ul>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
