<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LinuxCNC PoKeysLib-Comp: PoKeys HAL Component Interface Parity Analysis</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="custom_doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">LinuxCNC PoKeysLib-Comp
   </div>
   <div id="projectbrief">unofficial PoKeys HAL-Component for LinuxCNC</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__home_cnc_actions_runner__work_LinuxCnc_PokeysLibComp_LinuxCnc_PokeysLibComp_external_pokeysHal_INTERFACE_PARITY_ANALYSIS.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">PoKeys HAL Component Interface Parity Analysis </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md506"></a>
Overview</h1>
<p >This document compares the current RT implementation with the userspace implementation to ensure compatibility.</p>
<h1><a class="anchor" id="autotoc_md507"></a>
Current Implementation Status</h1>
<h2><a class="anchor" id="autotoc_md508"></a>
✅ &lt;strong&gt;Already Implemented&lt;/strong&gt;</h2>
<ul>
<li>Basic digital I/O (limited)</li>
<li>Analog I/O (limited)</li>
<li>RTC functionality</li>
<li>Basic encoder support</li>
<li>Device connection management</li>
</ul>
<h2><a class="anchor" id="autotoc_md509"></a>
❌ &lt;strong&gt;Missing Critical Features&lt;/strong&gt;</h2>
<h3><a class="anchor" id="autotoc_md510"></a>
1. &lt;strong&gt;Device Information Pins&lt;/strong&gt;</h3>
<p >Current implementation lacks comprehensive device capability reporting: </p><div class="fragment"><div class="line"><span class="comment">// Missing from current implementation:</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#a963951018d1233c59a0f3713fa18ebf5">info_PinCount</a>;</div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#a591421902bf7277184afc99d5c10ffa9">info_PWMCount</a>; </div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#ab34f4f6bce015f503a226b1c7d059ae6">info_EncodersCount</a>;</div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#aac8a7483276a443924584dbacf0f52de">info_PulseEnginev2</a>;</div>
<div class="line"><span class="comment">// ... 25+ more info pins</span></div>
<div class="ttc" id="ahal_8h_html_ae92d78d3b2910b3bc9531b9507c92cc6"><div class="ttname"><a href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a></div><div class="ttdeci">volatile rtapi_u32 hal_u32_t</div><div class="ttdef"><b>Definition:</b> <a href="hal_8h_source.html#l00316">hal.h:316</a></div></div>
<div class="ttc" id="apokeys_8c_html_a591421902bf7277184afc99d5c10ffa9"><div class="ttname"><a href="pokeys_8c.html#a591421902bf7277184afc99d5c10ffa9">info_PWMCount</a></div><div class="ttdeci">#define info_PWMCount</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00806">pokeys.c:806</a></div></div>
<div class="ttc" id="apokeys_8c_html_a963951018d1233c59a0f3713fa18ebf5"><div class="ttname"><a href="pokeys_8c.html#a963951018d1233c59a0f3713fa18ebf5">info_PinCount</a></div><div class="ttdeci">#define info_PinCount</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00804">pokeys.c:804</a></div></div>
<div class="ttc" id="apokeys_8c_html_aac8a7483276a443924584dbacf0f52de"><div class="ttname"><a href="pokeys_8c.html#aac8a7483276a443924584dbacf0f52de">info_PulseEnginev2</a></div><div class="ttdeci">#define info_PulseEnginev2</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00874">pokeys.c:874</a></div></div>
<div class="ttc" id="apokeys_8c_html_ab34f4f6bce015f503a226b1c7d059ae6"><div class="ttname"><a href="pokeys_8c.html#ab34f4f6bce015f503a226b1c7d059ae6">info_EncodersCount</a></div><div class="ttdeci">#define info_EncodersCount</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00810">pokeys.c:810</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md511"></a>
2. &lt;strong&gt;Complete Encoder Interface&lt;/strong&gt;</h3>
<p >Missing standard LinuxCNC encoder pins: </p><div class="fragment"><div class="line"><span class="comment">// Missing encoder pins per channel:</span></div>
<div class="line"><a class="code hl_typedef" href="PoKeysLibHal_8h.html#a74d4e1e0fb06c69c2a819757c1e0524f">hal_s32_t</a> *count;        <span class="comment">// Current count</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *position;   <span class="comment">// Scaled position  </span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *velocity;   <span class="comment">// Velocity</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *reset;        <span class="comment">// Reset command</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *index_enable; <span class="comment">// Index enable</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> scale;       <span class="comment">// Scale parameter</span></div>
<div class="ttc" id="aPoKeysLibHal_8h_html_a74d4e1e0fb06c69c2a819757c1e0524f"><div class="ttname"><a href="PoKeysLibHal_8h.html#a74d4e1e0fb06c69c2a819757c1e0524f">hal_s32_t</a></div><div class="ttdeci">int hal_s32_t</div><div class="ttdef"><b>Definition:</b> <a href="PoKeysLibHal_8h_source.html#l00032">PoKeysLibHal.h:32</a></div></div>
<div class="ttc" id="ahal_8h_html_a16fd07b6ebe0fc59d74da72038bf841d"><div class="ttname"><a href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a></div><div class="ttdeci">#define hal_float_t</div><div class="ttdef"><b>Definition:</b> <a href="hal_8h_source.html#l00322">hal.h:322</a></div></div>
<div class="ttc" id="ahal_8h_html_af5c6672ad6690e0e7aec13953a34171f"><div class="ttname"><a href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a></div><div class="ttdeci">volatile bool hal_bit_t</div><div class="ttdef"><b>Definition:</b> <a href="hal_8h_source.html#l00315">hal.h:315</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md512"></a>
3. &lt;strong&gt;PulseEngine v2 Support&lt;/strong&gt;</h3>
<p >Critical for CNC applications - completely missing: </p><div class="fragment"><div class="line"><span class="comment">// Missing PEv2 interface:</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *joint_pos_cmd[8];    <span class="comment">// Position command</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *joint_vel_cmd[8];    <span class="comment">// Velocity command  </span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *joint_pos_fb[8];     <span class="comment">// Position feedback</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *joint_in_position[8];  <span class="comment">// In position status</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *AxesState[8];          <span class="comment">// Axis states</span></div>
<div class="line"><span class="comment">// ... 100+ more PEv2 pins</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md513"></a>
4. &lt;strong&gt;Advanced I/O Features&lt;/strong&gt;</h3>
<p >Missing scaling, inversion, and configuration: </p><div class="fragment"><div class="line"><span class="comment">// Missing I/O features:</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> <a class="code hl_define" href="pokeys_8c.html#a94ed7f5c7cd0a5a4a5522e4175d730c7">adcin_scale</a>[7];       <span class="comment">// ADC scaling</span></div>
<div class="line"><a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> <a class="code hl_define" href="pokeys_8c.html#a531abf6e2392a00d68bff8da1a748a78">adcin_offset</a>[7];      <span class="comment">// ADC offset</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> <a class="code hl_define" href="pokeys_8c.html#a4b1bb04098a51b3231a6583cb5807030">digout_invert</a>[55];      <span class="comment">// Output inversion</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> Pin_Function[55];       <span class="comment">// Pin function config</span></div>
<div class="ttc" id="apokeys_8c_html_a4b1bb04098a51b3231a6583cb5807030"><div class="ttname"><a href="pokeys_8c.html#a4b1bb04098a51b3231a6583cb5807030">digout_invert</a></div><div class="ttdeci">#define digout_invert(i)</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00933">pokeys.c:933</a></div></div>
<div class="ttc" id="apokeys_8c_html_a531abf6e2392a00d68bff8da1a748a78"><div class="ttname"><a href="pokeys_8c.html#a531abf6e2392a00d68bff8da1a748a78">adcin_offset</a></div><div class="ttdeci">#define adcin_offset(i)</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00931">pokeys.c:931</a></div></div>
<div class="ttc" id="apokeys_8c_html_a94ed7f5c7cd0a5a4a5522e4175d730c7"><div class="ttname"><a href="pokeys_8c.html#a94ed7f5c7cd0a5a4a5522e4175d730c7">adcin_scale</a></div><div class="ttdeci">#define adcin_scale(i)</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00929">pokeys.c:929</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md514"></a>
5. &lt;strong&gt;PoExtBus and PoNET Support&lt;/strong&gt;</h3>
<p >Missing expansion bus interfaces: </p><div class="fragment"><div class="line"><span class="comment">// Missing PoExtBus:</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *PoExtBus_digin_in[16];</div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *PoExtBus_digout_out[16];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Missing PoNET:</span></div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *kbd48CNC_Button[48];</div>
<div class="line"><a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *kbd48CNC_LED[48];</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md515"></a>
Required Implementation Steps</h1>
<h2><a class="anchor" id="autotoc_md516"></a>
Phase 1: Core Interface Expansion</h2>
<ol type="1">
<li><b>Add device info pins</b> - Essential for capability detection</li>
<li><b>Complete encoder interface</b> - Standard LinuxCNC compatibility <br  />
</li>
<li><b>Expand I/O interface</b> - Add scaling/inversion/configuration</li>
</ol>
<h2><a class="anchor" id="autotoc_md517"></a>
Phase 2: Motion Control</h2>
<ol type="1">
<li><b>Implement PulseEngine v2</b> - Critical for CNC functionality</li>
<li><b>Add homing support</b> - Automated homing sequences</li>
<li><b>Add limit switch handling</b> - Safety features</li>
</ol>
<h2><a class="anchor" id="autotoc_md518"></a>
Phase 3: Advanced Features</h2>
<ol type="1">
<li><b>PoExtBus support</b> - I/O expansion</li>
<li><b>PoNET support</b> - Networked devices</li>
<li><b>INI file integration</b> - Configuration persistence</li>
</ol>
<h1><a class="anchor" id="autotoc_md519"></a>
Compatibility Requirements</h1>
<h2><a class="anchor" id="autotoc_md520"></a>
HAL Pin and Parameter Interface (CRITICAL)</h2>
<p >Must match userspace implementation exactly for LinuxCNC configuration compatibility:</p>
<p ><b>Pin Naming Convention:</b> </p><div class="fragment"><div class="line"><span class="comment">// Required HAL pin names (userspace compatible):</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.count&quot;</span>      <span class="comment">// Encoder count</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.position&quot;</span>   <span class="comment">// Encoder position  </span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.velocity&quot;</span>   <span class="comment">// Encoder velocity</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.reset&quot;</span>      <span class="comment">// Encoder reset</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.index-enable&quot;</span> <span class="comment">// Index enable</span></div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.joint.00.pos-cmd&quot;</span>      <span class="comment">// Joint position command</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.joint.00.vel-cmd&quot;</span>      <span class="comment">// Joint velocity command</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.joint.00.pos-fb&quot;</span>       <span class="comment">// Joint position feedback</span></div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.info.PinCount&quot;</span>         <span class="comment">// Device info pins</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.info.EncodersCount&quot;</span>    <span class="comment">// Number of encoders</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.info.PulseEnginev2&quot;</span>    <span class="comment">// PEv2 capability</span></div>
<div class="line"> </div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.pin.00.in&quot;</span>             <span class="comment">// Digital input</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.pin.00.out&quot;</span>            <span class="comment">// Digital output</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.adc.00.value&quot;</span>          <span class="comment">// Analog input</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Current implementation (INCOMPATIBLE):</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys-async.0.in-00&quot;</span>           <span class="comment">// ❌ Wrong naming</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys-async.0.ain-00&quot;</span>          <span class="comment">// ❌ Wrong naming</span></div>
</div><!-- fragment --><p ><b>Parameter Names:</b> </p><div class="fragment"><div class="line"><span class="comment">// Required parameter names:</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.devSerial&quot;</span>             <span class="comment">// Device serial number</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.encoder.00.scale&quot;</span>      <span class="comment">// Encoder scale factor</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.adc.00.scale&quot;</span>          <span class="comment">// ADC scale factor</span></div>
<div class="line"><span class="stringliteral">&quot;pokeys.0.adc.00.offset&quot;</span>         <span class="comment">// ADC offset</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md521"></a>
Internal Implementation (FLEXIBLE)</h2>
<p >Function names and internal structure can be different - these are implementation details: </p><div class="fragment"><div class="line"><span class="comment">// Internal functions can have any names:</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> my_encoder_update(...)     <span class="comment">// ✅ OK - internal function</span></div>
<div class="line">static <span class="keywordtype">void</span> my_io_update(...)          <span class="comment">// ✅ OK - internal function  </span></div>
<div class="line">static <span class="keywordtype">void</span> my_pev2_update(...)        <span class="comment">// ✅ OK - internal function</span></div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md522"></a>
Implementation Priority</h1>
<h2><a class="anchor" id="autotoc_md523"></a>
&lt;strong&gt;HIGH PRIORITY&lt;/strong&gt; (Required for basic compatibility)</h2>
<ol type="1">
<li>Device info pins</li>
<li>Complete encoder interface</li>
<li>Enhanced I/O with scaling</li>
<li>Standard pin naming convention</li>
</ol>
<h2><a class="anchor" id="autotoc_md524"></a>
&lt;strong&gt;MEDIUM PRIORITY&lt;/strong&gt; (CNC functionality)</h2>
<ol type="1">
<li>PulseEngine v2 basic support</li>
<li>Homing sequences <br  />
</li>
<li>Position/velocity control</li>
<li>Limit switch handling</li>
</ol>
<h2><a class="anchor" id="autotoc_md525"></a>
&lt;strong&gt;LOW PRIORITY&lt;/strong&gt; (Advanced features)</h2>
<ol type="1">
<li>PoExtBus expansion</li>
<li>PoNET devices</li>
<li>Advanced motion features</li>
<li>Full INI integration</li>
</ol>
<h1><a class="anchor" id="autotoc_md526"></a>
Testing Requirements</h1>
<h2><a class="anchor" id="autotoc_md527"></a>
Interface Compatibility Test</h2>
<div class="fragment"><div class="line"># Must expose same HAL pins as userspace version:</div>
<div class="line">halcmd show pin pokeys.0.encoder.00.count</div>
<div class="line">halcmd show pin pokeys.0.encoder.00.position  </div>
<div class="line">halcmd show pin pokeys.0.joint.00.pos-cmd</div>
<div class="line">halcmd show pin pokeys.0.info.PinCount</div>
<div class="line">halcmd show param pokeys.0.encoder.00.scale</div>
<div class="line"> </div>
<div class="line"># Current implementation fails these tests:</div>
<div class="line">halcmd show pin pokeys-async.0.in-00    # ❌ Wrong naming convention</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md528"></a>
LinuxCNC Configuration Compatibility</h2>
<div class="fragment"><div class="line"># LinuxCNC HAL file must work with same pin names:</div>
<div class="line">[HAL]</div>
<div class="line"># These commands must work with RT implementation:</div>
<div class="line">net encoder-count &lt;= pokeys.0.encoder.00.count</div>
<div class="line">net joint-pos-cmd =&gt; pokeys.0.joint.00.pos-cmd  </div>
<div class="line">setp pokeys.0.encoder.00.scale 1000</div>
<div class="line"> </div>
<div class="line"># Current implementation breaks existing configs</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md529"></a>
Conclusion</h1>
<p >The current implementation provides **~10%** of the userspace HAL interface compatibility. To achieve full compatibility, the HAL pin and parameter interface must be expanded significantly.</p>
<p ><b>Critical Issue:</b> Pin naming convention is completely incompatible:</p><ul>
<li>Userspace: <code>pokeys.0.encoder.00.count</code></li>
<li>Current RT: <code>pokeys-async.0.in-00</code></li>
</ul>
<p ><b>Priority for HAL Interface Compatibility:</b></p><ol type="1">
<li><b>Fix pin naming convention</b> - Change component name from "pokeys_async" to "pokeys"</li>
<li><b>Add missing HAL pins</b> - Encoder, motion control, device info pins <br  />
</li>
<li><b>Add missing parameters</b> - Scale factors, configuration parameters</li>
<li><b>Maintain same pin semantics</b> - Data types, directions, ranges</li>
</ol>
<p ><b>Implementation Strategy:</b></p><ul>
<li>Keep existing internal async functions (they work well)</li>
<li>Change only the HAL pin export layer for compatibility</li>
<li>Add missing pin types while reusing existing communication code</li>
<li>Ensure drop-in replacement for userspace driver</li>
</ul>
<p >This will ensure existing LinuxCNC configurations work without modification when switching from userspace to RT driver.</p>
<h1><a class="anchor" id="autotoc_md530"></a>
Real-Time Implementation Concepts</h1>
<h2><a class="anchor" id="autotoc_md531"></a>
Core Real-Time Design Principles</h2>
<h3><a class="anchor" id="autotoc_md532"></a>
1. &lt;strong&gt;Separation of Concerns&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// RT-safe data structures (shared between RT and non-RT contexts)</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="comment">// RT thread only reads, non-RT thread only writes</span></div>
<div class="line">    <span class="keyword">volatile</span> <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> joint_pos_cmd[8];</div>
<div class="line">    <span class="keyword">volatile</span> <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> joint_vel_cmd[8];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// RT thread only writes, non-RT thread only reads  </span></div>
<div class="line">    <span class="keyword">volatile</span> <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> joint_pos_fb[8];</div>
<div class="line">    <span class="keyword">volatile</span> <a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> axis_state[8];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Atomic flags for coordination</span></div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> config_changed;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> emergency_stop;</div>
<div class="line">} rt_shared_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// RT Thread: Fast, deterministic, no blocking calls</span></div>
<div class="line"><span class="keywordtype">void</span> pokeys_rt_thread(<span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="comment">// Only read commands, write feedback</span></div>
<div class="line">    <span class="comment">// No malloc, no printf, no blocking I/O</span></div>
<div class="line">    update_outputs_from_hal();</div>
<div class="line">    read_device_status_cache();</div>
<div class="line">    update_hal_inputs();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Non-RT Thread: Handles async communication</span></div>
<div class="line"><span class="keywordtype">void</span> pokeys_async_thread(<span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="comment">// Handle all PoKeysLib async calls here</span></div>
<div class="line">    <span class="comment">// Update shared cache when data arrives</span></div>
<div class="line">    process_async_responses();</div>
<div class="line">    send_async_commands();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md533"></a>
2. &lt;strong&gt;Lock-Free Communication Pattern&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Double-buffering for RT-safe data exchange</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    device_status_t buffer[2];</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">int</span> write_index;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">int</span> read_index;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> data_ready;</div>
<div class="line">} double_buffer_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Non-RT thread updates back buffer</span></div>
<div class="line"><span class="keywordtype">void</span> async_callback(device_status_t *status) {</div>
<div class="line">    <span class="keywordtype">int</span> write_idx = (shared_data.read_index + 1) % 2;</div>
<div class="line">    memcpy(&amp;status_buffer.buffer[write_idx], status, <span class="keyword">sizeof</span>(device_status_t));</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Atomic switch</span></div>
<div class="line">    status_buffer.write_index = write_idx;</div>
<div class="line">    status_buffer.data_ready = <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// RT thread reads front buffer</span></div>
<div class="line"><span class="keywordtype">void</span> rt_read_status(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (status_buffer.data_ready) {</div>
<div class="line">        shared_data.read_index = status_buffer.write_index;</div>
<div class="line">        status_buffer.data_ready = <span class="keyword">false</span>;</div>
<div class="line">        <span class="comment">// Now use buffer[read_index] safely</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md534"></a>
3. &lt;strong&gt;Async Command Queue Pattern&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Command queue for RT -&gt; Async communication</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keyword">enum</span> { CMD_SET_POSITION, CMD_START_HOMING, CMD_ENABLE_AXIS } type;</div>
<div class="line">    <span class="keywordtype">int</span> axis;</div>
<div class="line">    <span class="keywordtype">float</span> value;</div>
<div class="line">    <span class="keywordtype">bool</span> processed;</div>
<div class="line">} <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MAX_COMMANDS 64</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> commands[MAX_COMMANDS];</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">int</span> head, tail;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">int</span> count;</div>
<div class="line">} command_queue_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// RT thread: Queue commands (non-blocking)</span></div>
<div class="line"><span class="keywordtype">bool</span> queue_async_command(command_queue_t *q, <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> *cmd) {</div>
<div class="line">    <span class="keywordflow">if</span> (q-&gt;count &gt;= MAX_COMMANDS) <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">// Queue full</span></div>
<div class="line">    </div>
<div class="line">    q-&gt;commands[q-&gt;head] = *cmd;</div>
<div class="line">    q-&gt;head = (q-&gt;head + 1) % MAX_COMMANDS;</div>
<div class="line">    __atomic_fetch_add(&amp;q-&gt;count, 1, __ATOMIC_SEQ_CST);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Non-RT thread: Process commands</span></div>
<div class="line"><span class="keywordtype">void</span> process_command_queue(command_queue_t *q) {</div>
<div class="line">    <span class="keywordflow">while</span> (q-&gt;count &gt; 0) {</div>
<div class="line">        <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> *cmd = &amp;q-&gt;commands[q-&gt;tail];</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">switch</span> (cmd-&gt;<a class="code hl_variable" href="structasync__command__t.html#a1d917c72907507e8f3f2ed732a02c806">type</a>) {</div>
<div class="line">            <span class="keywordflow">case</span> CMD_SET_POSITION:</div>
<div class="line">                PK_PEv2_PositionSetAsync(<a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>, cmd-&gt;axis, cmd-&gt;value);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            <span class="keywordflow">case</span> CMD_START_HOMING:</div>
<div class="line">                <a class="code hl_function" href="pokeys__async_8c.html#ad237da4187cb752d13bae3cc88a0a549">PK_PEv2_HomingStartAsync</a>(<a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>, 1 &lt;&lt; cmd-&gt;axis);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        q-&gt;tail = (q-&gt;tail + 1) % MAX_COMMANDS;</div>
<div class="line">        __atomic_fetch_sub(&amp;q-&gt;count, 1, __ATOMIC_SEQ_CST);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="apokeys_8c_html_a6d58c07bbd5a0f476a9c23c323c2547c"><div class="ttname"><a href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a></div><div class="ttdeci">sPoKeysDevice * dev</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00078">pokeys.c:78</a></div></div>
<div class="ttc" id="apokeys__async_8c_html_ad237da4187cb752d13bae3cc88a0a549"><div class="ttname"><a href="pokeys__async_8c.html#ad237da4187cb752d13bae3cc88a0a549">PK_PEv2_HomingStartAsync</a></div><div class="ttdeci">int PK_PEv2_HomingStartAsync(sPoKeysDevice *device)</div><div class="ttdef"><b>Definition:</b> <a href="PoKeysLibPulseEngine__v2Async_8c_source.html#l00252">PoKeysLibPulseEngine_v2Async.c:252</a></div></div>
<div class="ttc" id="astructasync__command__t_html"><div class="ttname"><a href="structasync__command__t.html">async_command_t</a></div><div class="ttdef"><b>Definition:</b> <a href="pokeys__async_8c_source.html#l00395">pokeys_async.c:395</a></div></div>
<div class="ttc" id="astructasync__command__t_html_a1d917c72907507e8f3f2ed732a02c806"><div class="ttname"><a href="structasync__command__t.html#a1d917c72907507e8f3f2ed732a02c806">async_command_t::type</a></div><div class="ttdeci">async_cmd_type_t type</div><div class="ttdef"><b>Definition:</b> <a href="pokeys__async_8c_source.html#l00396">pokeys_async.c:396</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md535"></a>
Implementation Strategy by Feature</h2>
<h3><a class="anchor" id="autotoc_md536"></a>
1. &lt;strong&gt;Device Info Pins (Non-Critical Path)&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Read once at startup, cache in RT-accessible memory</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#a963951018d1233c59a0f3713fa18ebf5">info_PinCount</a>;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#ab34f4f6bce015f503a226b1c7d059ae6">info_EncodersCount</a>;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#ae92d78d3b2910b3bc9531b9507c92cc6">hal_u32_t</a> *<a class="code hl_define" href="pokeys_8c.html#aac8a7483276a443924584dbacf0f52de">info_PulseEnginev2</a>;</div>
<div class="line">    <span class="comment">// ... other info pins</span></div>
<div class="line">} device_info_pins_t;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize once during HAL setup</span></div>
<div class="line"><span class="keywordtype">void</span> init_device_info_pins(<a class="code hl_struct" href="structsPoKeysDevice.html">sPoKeysDevice</a> *<a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>) {</div>
<div class="line">    <span class="comment">// These values don&#39;t change during runtime</span></div>
<div class="line">    *device_info.info_PinCount = <a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>-&gt;<a class="code hl_variable" href="structsPoKeysDevice.html#a338bc784fe1d4f6b0abcfced88ed7486">info</a>.<a class="code hl_variable" href="structsPoKeysDevice__Info.html#a9b4d158dd265e81bc2950b1b56060e65">iPinCount</a>;</div>
<div class="line">    *device_info.info_EncodersCount = <a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>-&gt;<a class="code hl_variable" href="structsPoKeysDevice.html#a338bc784fe1d4f6b0abcfced88ed7486">info</a>.<a class="code hl_variable" href="structsPoKeysDevice__Info.html#a3aff4f11f61b735438953f6899277822">iEncodersCount</a>;</div>
<div class="line">    *device_info.info_PulseEnginev2 = <a class="code hl_variable" href="pokeys_8c.html#a6d58c07bbd5a0f476a9c23c323c2547c">dev</a>-&gt;<a class="code hl_variable" href="structsPoKeysDevice.html#a338bc784fe1d4f6b0abcfced88ed7486">info</a>.<a class="code hl_variable" href="structsPoKeysDevice__Info.html#af06b7ba165611dc83b018aa047ac579d">iPulseEnginev2</a>;</div>
<div class="line">}</div>
<div class="ttc" id="astructsPoKeysDevice__Info_html_a3aff4f11f61b735438953f6899277822"><div class="ttname"><a href="structsPoKeysDevice__Info.html#a3aff4f11f61b735438953f6899277822">sPoKeysDevice_Info::iEncodersCount</a></div><div class="ttdeci">uint32_t iEncodersCount</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00331">PoKeysLib.h:331</a></div></div>
<div class="ttc" id="astructsPoKeysDevice__Info_html_a9b4d158dd265e81bc2950b1b56060e65"><div class="ttname"><a href="structsPoKeysDevice__Info.html#a9b4d158dd265e81bc2950b1b56060e65">sPoKeysDevice_Info::iPinCount</a></div><div class="ttdeci">uint32_t iPinCount</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00328">PoKeysLib.h:328</a></div></div>
<div class="ttc" id="astructsPoKeysDevice__Info_html_af06b7ba165611dc83b018aa047ac579d"><div class="ttname"><a href="structsPoKeysDevice__Info.html#af06b7ba165611dc83b018aa047ac579d">sPoKeysDevice_Info::iPulseEnginev2</a></div><div class="ttdeci">uint32_t iPulseEnginev2</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00364">PoKeysLib.h:364</a></div></div>
<div class="ttc" id="astructsPoKeysDevice_html"><div class="ttname"><a href="structsPoKeysDevice.html">sPoKeysDevice</a></div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00880">PoKeysLib.h:881</a></div></div>
<div class="ttc" id="astructsPoKeysDevice_html_a338bc784fe1d4f6b0abcfced88ed7486"><div class="ttname"><a href="structsPoKeysDevice.html#a338bc784fe1d4f6b0abcfced88ed7486">sPoKeysDevice::info</a></div><div class="ttdeci">sPoKeysDevice_Info info</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00885">PoKeysLib.h:885</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md537"></a>
2. &lt;strong&gt;Encoder Interface (RT-Critical)&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// RT-safe encoder implementation</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <a class="code hl_typedef" href="PoKeysLibHal_8h.html#a74d4e1e0fb06c69c2a819757c1e0524f">hal_s32_t</a> *count;</div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *position;</div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *velocity;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *reset;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *index_enable;</div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> scale;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// RT-safe state</span></div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a32f2e37ee053cf2ce8ca28d1f74630e5">int32_t</a> last_count;</div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a32f2e37ee053cf2ce8ca28d1f74630e5">int32_t</a> current_count;</div>
<div class="line">    <span class="keywordtype">bool</span> reset_requested;</div>
<div class="line">} encoder_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> rt_update_encoders(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; encoder_count; <a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a>++) {</div>
<div class="line">        encoder_data_t *enc = &amp;encoders[<a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Read from cached device data (populated by async thread)</span></div>
<div class="line">        enc-&gt;current_count = device_cache.encoder_counts[<a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a>];</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Handle reset request</span></div>
<div class="line">        <span class="keywordflow">if</span> (*enc-&gt;reset &amp;&amp; !enc-&gt;reset_requested) {</div>
<div class="line">            enc-&gt;reset_requested = <span class="keyword">true</span>;</div>
<div class="line">            <span class="comment">// Queue async reset command</span></div>
<div class="line">            <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> cmd = {CMD_RESET_ENCODER, <a class="code hl_variable" href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a>, 0, <span class="keyword">false</span>};</div>
<div class="line">            queue_async_command(&amp;cmd_queue, &amp;cmd);</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Calculate position and velocity</span></div>
<div class="line">        *enc-&gt;count = enc-&gt;current_count;</div>
<div class="line">        *enc-&gt;position = enc-&gt;current_count / enc-&gt;scale;</div>
<div class="line">        *enc-&gt;velocity = (enc-&gt;current_count - enc-&gt;last_count) * thread_freq / enc-&gt;scale;</div>
<div class="line">        </div>
<div class="line">        enc-&gt;last_count = enc-&gt;current_count;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="apokeys_8c_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="pokeys_8c.html#acb559820d9ca11295b4500f179ef6392">i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="pokeys_8c_source.html#l00970">pokeys.c:970</a></div></div>
<div class="ttc" id="apokeyslib_2PoKeysLib_8h_html_a32f2e37ee053cf2ce8ca28d1f74630e5"><div class="ttname"><a href="pokeyslib_2PoKeysLib_8h.html#a32f2e37ee053cf2ce8ca28d1f74630e5">int32_t</a></div><div class="ttdeci">int int32_t</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00032">PoKeysLib.h:32</a></div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md538"></a>
3. &lt;strong&gt;PulseEngine v2 (Complex RT-Critical)&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Hierarchical state management</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    PE_STATE_IDLE,</div>
<div class="line">    PE_STATE_POSITIONING, </div>
<div class="line">    PE_STATE_HOMING,</div>
<div class="line">    PE_STATE_ERROR</div>
<div class="line">} pe_axis_state_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="comment">// HAL interface</span></div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *pos_cmd;</div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *vel_cmd;</div>
<div class="line">    <a class="code hl_define" href="hal_8h.html#a16fd07b6ebe0fc59d74da72038bf841d">hal_float_t</a> *pos_fb;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *in_position;</div>
<div class="line">    <a class="code hl_typedef" href="hal_8h.html#af5c6672ad6690e0e7aec13953a34171f">hal_bit_t</a> *homing_active;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// RT-safe state machine</span></div>
<div class="line">    pe_axis_state_t current_state;</div>
<div class="line">    pe_axis_state_t target_state;</div>
<div class="line">    <span class="keywordtype">float</span> last_pos_cmd;</div>
<div class="line">    <span class="keywordtype">float</span> last_vel_cmd;</div>
<div class="line">    <span class="keywordtype">bool</span> state_changed;</div>
<div class="line">} pe_axis_data_t;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> rt_update_pe_axis(<span class="keywordtype">int</span> axis) {</div>
<div class="line">    pe_axis_data_t *ax = &amp;pe_axes[axis];</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Detect command changes</span></div>
<div class="line">    <span class="keywordflow">if</span> (*ax-&gt;pos_cmd != ax-&gt;last_pos_cmd) {</div>
<div class="line">        <span class="comment">// Queue position command</span></div>
<div class="line">        <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> cmd = {CMD_SET_POSITION, axis, *ax-&gt;pos_cmd, <span class="keyword">false</span>};</div>
<div class="line">        queue_async_command(&amp;cmd_queue, &amp;cmd);</div>
<div class="line">        ax-&gt;last_pos_cmd = *ax-&gt;pos_cmd;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Update feedback from cached data</span></div>
<div class="line">    *ax-&gt;pos_fb = device_cache.axis_positions[axis] / axis_scale[axis];</div>
<div class="line">    *ax-&gt;in_position = device_cache.axis_in_position &amp; (1 &lt;&lt; axis);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// State machine updates</span></div>
<div class="line">    rt_update_axis_state_machine(axis);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> rt_update_axis_state_machine(<span class="keywordtype">int</span> axis) {</div>
<div class="line">    pe_axis_data_t *ax = &amp;pe_axes[axis];</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">switch</span> (ax-&gt;current_state) {</div>
<div class="line">        <span class="keywordflow">case</span> PE_STATE_IDLE:</div>
<div class="line">            <span class="keywordflow">if</span> (ax-&gt;target_state == PE_STATE_HOMING) {</div>
<div class="line">                *ax-&gt;homing_active = <span class="keyword">true</span>;</div>
<div class="line">                ax-&gt;current_state = PE_STATE_HOMING;</div>
<div class="line">                <span class="comment">// Queue homing start command</span></div>
<div class="line">                <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> cmd = {CMD_START_HOMING, axis, 0, <span class="keyword">false</span>};</div>
<div class="line">                queue_async_command(&amp;cmd_queue, &amp;cmd);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">            </div>
<div class="line">        <span class="keywordflow">case</span> PE_STATE_HOMING:</div>
<div class="line">            <span class="comment">// Check if homing completed (from device cache)</span></div>
<div class="line">            <span class="keywordflow">if</span> (device_cache.homing_status &amp; (1 &lt;&lt; axis)) {</div>
<div class="line">                *ax-&gt;homing_active = <span class="keyword">false</span>;</div>
<div class="line">                ax-&gt;current_state = PE_STATE_IDLE;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md539"></a>
Threading Architecture</h2>
<h3><a class="anchor" id="autotoc_md540"></a>
1. &lt;strong&gt;Multi-Threading Model&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Main RT thread: Fixed frequency (typically 1kHz)</span></div>
<div class="line"><span class="keywordtype">void</span> rt_main_thread(<span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keywordflow">while</span> (!shutdown_requested) {</div>
<div class="line">        rt_wait_for_period();  <span class="comment">// Wait for next RT cycle</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Fast, deterministic operations only</span></div>
<div class="line">        rt_update_digital_io();    <span class="comment">// ~10µs</span></div>
<div class="line">        rt_update_encoders();      <span class="comment">// ~20µs  </span></div>
<div class="line">        rt_update_pe_axes();       <span class="comment">// ~30µs</span></div>
<div class="line">        rt_update_hal_outputs();   <span class="comment">// ~10µs</span></div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Total: ~70µs per cycle (plenty of margin for 1ms period)</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Async communication thread: Variable timing</span></div>
<div class="line"><span class="keywordtype">void</span> async_comm_thread(<span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keywordflow">while</span> (!shutdown_requested) {</div>
<div class="line">        <span class="comment">// Process queued commands</span></div>
<div class="line">        process_command_queue(&amp;cmd_queue);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Handle async responses</span></div>
<div class="line">        process_async_responses();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Periodic status updates</span></div>
<div class="line">        <span class="keywordflow">if</span> (time_for_status_update()) {</div>
<div class="line">            request_device_status_async();</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        usleep(1000);  <span class="comment">// 1ms sleep - not RT critical</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md541"></a>
2. &lt;strong&gt;Error Handling Strategy&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// RT-safe error handling</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    ERR_NONE = 0,</div>
<div class="line">    ERR_COMMUNICATION,</div>
<div class="line">    ERR_DEVICE_FAULT,</div>
<div class="line">    ERR_LIMIT_SWITCH,</div>
<div class="line">    ERR_EMERGENCY_STOP</div>
<div class="line">} error_code_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="keyword">volatile</span> error_code_t error_code;</div>
<div class="line">    <span class="keyword">volatile</span> <span class="keywordtype">bool</span> error_active;</div>
<div class="line">    <span class="keyword">volatile</span> <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> error_count;</div>
<div class="line">} error_state_t;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> rt_handle_errors(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">if</span> (error_state.error_active) {</div>
<div class="line">        <span class="comment">// Immediate RT-safe actions</span></div>
<div class="line">        disable_all_outputs();</div>
<div class="line">        set_emergency_stop_state();</div>
<div class="line">        </div>
<div class="line">        <span class="comment">// Queue async error recovery</span></div>
<div class="line">        <a class="code hl_struct" href="structasync__command__t.html">async_command_t</a> cmd = {CMD_ERROR_RECOVERY, 0, error_state.error_code, <span class="keyword">false</span>};</div>
<div class="line">        queue_async_command(&amp;cmd_queue, &amp;cmd);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="apokeyslib_2PoKeysLib_8h_html_a435d1572bf3f880d55459d9805097f62"><div class="ttname"><a href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div><div class="ttdeci">unsigned int uint32_t</div><div class="ttdef"><b>Definition:</b> <a href="pokeyslib_2PoKeysLib_8h_source.html#l00036">PoKeysLib.h:36</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md542"></a>
Memory Management</h2>
<h3><a class="anchor" id="autotoc_md543"></a>
1. &lt;strong&gt;Pre-allocated Structures&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// All memory allocated at startup - no runtime allocation</span></div>
<div class="line"><span class="preprocessor">#define MAX_AXES 8</span></div>
<div class="line"><span class="preprocessor">#define MAX_ENCODERS 25</span></div>
<div class="line"><span class="preprocessor">#define MAX_DIGITAL_PINS 55</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> pe_axis_data_t pe_axes[MAX_AXES];</div>
<div class="line"><span class="keyword">static</span> encoder_data_t encoders[MAX_ENCODERS];</div>
<div class="line"><span class="keyword">static</span> digital_pin_data_t digital_pins[MAX_DIGITAL_PINS];</div>
<div class="line"><span class="keyword">static</span> device_cache_t device_cache;</div>
<div class="line"><span class="keyword">static</span> command_queue_t cmd_queue;</div>
<div class="line"> </div>
<div class="line"><span class="comment">// No malloc/free in RT context - everything pre-allocated</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md544"></a>
2. &lt;strong&gt;Cache-Friendly Data Layout&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Structure data for cache efficiency</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <span class="comment">// Hot data - accessed every RT cycle</span></div>
<div class="line">    <span class="keywordtype">float</span> positions[MAX_AXES];</div>
<div class="line">    <span class="keywordtype">float</span> velocities[MAX_AXES];</div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> digital_inputs;</div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> axis_states;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Cold data - accessed less frequently  </span></div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> device_serial;</div>
<div class="line">    <a class="code hl_typedef" href="pokeyslib_2PoKeysLib_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> firmware_version;</div>
<div class="line">    device_info_t device_info;</div>
<div class="line">} <a class="code hl_typedef" href="hal_8h.html#aa17adc96cc3c5f079fc70d5a5c354c31">__attribute__</a>((packed)) device_cache_t;</div>
<div class="ttc" id="ahal_8h_html_aa17adc96cc3c5f079fc70d5a5c354c31"><div class="ttname"><a href="hal_8h.html#aa17adc96cc3c5f079fc70d5a5c354c31">__attribute__</a></div><div class="ttdeci">double real_t __attribute__((aligned(8)))</div><div class="ttdef"><b>Definition:</b> <a href="hal_8h_source.html#l00319">hal.h:319</a></div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md545"></a>
Configuration and Initialization</h2>
<h3><a class="anchor" id="autotoc_md546"></a>
1. &lt;strong&gt;RT-Safe Parameter Updates&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Parameter changes through non-RT thread</span></div>
<div class="line"><span class="keywordtype">void</span> update_encoder_scale(<span class="keywordtype">int</span> encoder, <span class="keywordtype">float</span> new_scale) {</div>
<div class="line">    <span class="comment">// Validate parameter</span></div>
<div class="line">    <span class="keywordflow">if</span> (new_scale == 0.0) <span class="keywordflow">return</span>;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Atomic update - RT thread will see consistent value</span></div>
<div class="line">    __atomic_store_n(&amp;encoders[encoder].scale, new_scale, __ATOMIC_SEQ_CST);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// RT thread reads parameters atomically</span></div>
<div class="line"><span class="keywordtype">void</span> rt_update_encoder_position(<span class="keywordtype">int</span> encoder) {</div>
<div class="line">    <span class="keywordtype">float</span> scale = __atomic_load_n(&amp;encoders[encoder].scale, __ATOMIC_SEQ_CST);</div>
<div class="line">    *encoders[encoder].position = encoders[encoder].current_count / scale;</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md547"></a>
Performance Considerations</h2>
<h3><a class="anchor" id="autotoc_md548"></a>
1. &lt;strong&gt;Timing Budgets&lt;/strong&gt;</h3>
<div class="fragment"><div class="line"><span class="comment">// Target timing for 1kHz RT thread (1000µs period):</span></div>
<div class="line"><span class="comment">// - Digital I/O update:     ~20µs</span></div>
<div class="line"><span class="comment">// - Encoder updates:        ~50µs  </span></div>
<div class="line"><span class="comment">// - PEv2 state machines:    ~100µs</span></div>
<div class="line"><span class="comment">// - HAL pin updates:        ~30µs</span></div>
<div class="line"><span class="comment">// - Error handling:         ~10µs</span></div>
<div class="line"><span class="comment">// - Margin for jitter:      ~790µs</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Monitor actual timing</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>timespec start_time, end_time;</div>
<div class="line"><span class="keywordtype">void</span> rt_timing_monitor(<span class="keywordtype">void</span>) {</div>
<div class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;start_time);</div>
<div class="line">    <span class="comment">// ... RT operations ...</span></div>
<div class="line">    clock_gettime(CLOCK_MONOTONIC, &amp;end_time);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">long</span> duration_us = (end_time.tv_nsec - start_time.tv_nsec) / 1000;</div>
<div class="line">    <span class="keywordflow">if</span> (duration_us &gt; 200) {  <span class="comment">// Warning threshold</span></div>
<div class="line">        <span class="comment">// Log timing violation (non-RT context)</span></div>
<div class="line">        queue_timing_warning(duration_us);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p >This architecture ensures:</p><ul>
<li><b>Deterministic RT performance</b> - No blocking calls in RT thread</li>
<li><b>Robust error handling</b> - Graceful degradation under fault conditions <br  />
</li>
<li><b>Scalable design</b> - Easy to add features without breaking RT constraints</li>
<li><b>HAL compatibility</b> - Standard LinuxCNC interface while maintaining RT safety </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
